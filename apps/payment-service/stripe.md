# Stripe 产品同步机制详解

在我们的架构中，每当 `product-service` 创建或删除产品时，都会通过 Kafka 通知 `payment-service` 在 Stripe 侧完成相应的产品同步。以下是为什么像 Stripe 这种支付框架需要“同步产品”而不仅仅是“直接下单”的核心原因：

### 1. 安全性与价格验证 (Security & Validation)

虽然可以直接在下单时传递价格，但这存在风险：

- **篡改风险**：如果完全依赖前端传参，攻击者可能修改请求，以极低的价格购买昂贵的商品。
- **服务端校验**：通过同步产品，下单时只需引用 Stripe 内部的 `Price ID` 或 `Product ID`。Stripe 会使用其系统内预存的、不可篡改的价格数据进行结算。

### 2. 财务管理与报表可视化 (Reporting & Dashboard)

同步产品后，Stripe Dashboard 的功能将得到完整发挥：

- **销售分析**：你可以直观地看到哪些单品（SKU）最畅销，查看特定产品的销售趋势图。
- **清晰账单**：导出的财务报表和发送给客户的收据将包含具体的产品名称、描述和图片，而不是一系列意义不明的“临时商品”条目。

### 3. 税务、促销与合规性 (Compliance & Taxes)

- **自动计税**：Stripe Tax 需要知道产品所属的税务类别（例如虚拟数字产品还是实物商品），这必须绑定在 Stripe 的产品对象上。
- **优惠券逻辑**：同步后的产品允许设置更复杂的促销策略，如“仅限 A 类产品使用的满减券”。

### 4. 客户门户与订单生命周期 (Portal & Lifecycle)

- **自服务门户**：Stripe 的 Customer Portal 允许用户登录查看自己的购买记录。如果同步了产品，用户在该页面可以看到高质量的商品展示。
- **订阅与退款**：对于涉及退货、部分退款或后续订阅的项目，拥有稳定的产品标识号（ID）会让这些自动流转逻辑更加健壮。

---

### 项目当前模式：混合模式 (Mixed Mode)

在本项目目前的实现中，我们采取了**“异步同步 + 动态传值”**的混合模式：

1. **异步同步 (Kafka)**：用于在 Stripe 后台保留一份产品底账，确保财务对账和报表的可视化。
2. **动态传值 (`price_data`)**：在 Session 创建阶段直接传递金额，这保证了下单的极高灵活性，即使同步过程因网络延迟稍慢，也不会阻塞用户的下单流程。

**总结**：直接下单（Ad-hoc）适合最快上线，但同步产品（Synced）才是构建成熟电商平台、满足审计和精细化运营的基础。
